{% extends "base.html" %}
{% load static %}

{% block title %}Register Vehicle | RDFS{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'styles/vehicles/03.css' %}">
<div class="container py-4 form-container">
  <div class="rdfs-page-header">
    <div>
      <h1 class="rdfs-page-title">
        <i class="fas fa-truck-plus me-2"></i> Register New Vehicle
      </h1>
      <p class="rdfs-page-sub">
        <i class="fas fa-info-circle me-1"></i> Fill in the details below to register a new vehicle
      </p>
    </div>
    <a href="{% url 'vehicles:registered_vehicles' %}" class="rdfs-return-btn">
      <i class="fas fa-arrow-left me-1"></i> Back to Vehicles
    </a>
  </div>

  <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Error:</strong> {{ form.non_field_errors }}
      </div>
    {% endif %}

    <!-- Basic Information -->
    <div class="section-box">
      <h2 class="section-title">
        <i class="fas fa-info-circle me-2"></i> Basic Information
      </h2>

      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="{{ form.vehicle_name.id_for_label }}" class="form-label">
            <i class="fas fa-car me-1"></i> Vehicle Name
            <span class="text-muted">(Optional)</span>
          </label>
          <input type="text" 
                 name="{{ form.vehicle_name.name }}"
                 id="{{ form.vehicle_name.id_for_label }}"
                 class="form-control {% if form.vehicle_name.errors %}is-invalid{% endif %}"
                 placeholder="e.g. Toyota Grandia 2023"
                 value="{{ form.vehicle_name.value|default:'' }}">
          {% if form.vehicle_name.errors %}
            <div class="invalid-feedback">
              <i class="fas fa-exclamation-circle me-1"></i> {{ form.vehicle_name.errors.0 }}
            </div>
          {% endif %}
          <small class="form-text text-muted">
            <i class="fas fa-lightbulb me-1"></i> Enter the vehicle's model and make
          </small>
        </div>

        <div class="form-group col-md-6">
          <label for="{{ form.vehicle_type.id_for_label }}" class="form-label required">
            <i class="fas fa-truck-pickup me-1"></i> Vehicle Type
          </label>
          {{ form.vehicle_type }}
          {% if form.vehicle_type.errors %}
            <div class="invalid-feedback">
              <i class="fas fa-exclamation-circle me-1"></i> {{ form.vehicle_type.errors.0 }}
            </div>
          {% else %}
            <div class="invalid-feedback">
              <i class="fas fa-exclamation-circle me-1"></i> Please select the vehicle type.
            </div>
          {% endif %}
          <small class="form-text text-muted">
            <i class="fas fa-lightbulb me-1"></i> Select the type of vehicle
          </small>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="{{ form.assigned_driver.id_for_label }}" class="form-label required">
            <i class="fas fa-id-card-alt me-1"></i> Assigned Driver
          </label>
          {{ form.assigned_driver }}
          {% if form.assigned_driver.errors %}
            <div class="invalid-feedback">
              <i class="fas fa-exclamation-circle me-1"></i> {{ form.assigned_driver.errors.0 }}
            </div>
          {% else %}
            <div class="invalid-feedback">
              <i class="fas fa-exclamation-circle me-1"></i> Please select the driver assigned to this vehicle.
            </div>
          {% endif %}
          <small class="form-text text-muted">
            <i class="fas fa-lightbulb me-1"></i> Select the driver assigned to this vehicle
          </small>
        </div>
        
        <div class="form-group col-md-6">
          <label for="{{ form.ownership_type.id_for_label }}" class="form-label required">
            <i class="fas fa-key me-1"></i> Ownership Type
          </label>
          {{ form.ownership_type }}
          {% if form.ownership_type.errors %}
            <div class="invalid-feedback">
              <i class="fas fa-exclamation-circle me-1"></i> {{ form.ownership_type.errors.0 }}
            </div>
          {% else %}
            <div class="invalid-feedback">
              <i class="fas fa-exclamation-circle me-1"></i> Please select the ownership type.
            </div>
          {% endif %}
          <small class="form-text text-muted">
            <i class="fas fa-lightbulb me-1"></i> Select the ownership type
          </small>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="{{ form.route.id_for_label }}" class="form-label">
            <i class="fas fa-route me-1"></i> Route
            <span class="text-muted">(Optional)</span>
          </label>
          {{ form.route }}
          {% if form.route.errors %}
            <div class="invalid-feedback">
              <i class="fas fa-exclamation-circle me-1"></i> {{ form.route.errors.0 }}
            </div>
          {% endif %}
          <small class="form-text text-muted">
            <i class="fas fa-lightbulb me-1"></i> Select the regular route for this vehicle
          </small>
        </div>
        
        <div class="form-group col-md-6">
          <label for="{{ form.seat_capacity.id_for_label }}" class="form-label">
            <i class="fas fa-users me-1"></i> Seat Capacity
            <span class="text-muted">(Optional)</span>
          </label>
          <input type="number" 
                 name="{{ form.seat_capacity.name }}"
                 id="{{ form.seat_capacity.id_for_label }}"
                 class="form-control {% if form.seat_capacity.errors %}is-invalid{% endif %}"
                 placeholder="e.g. 12"
                 min="1"
                 value="{{ form.seat_capacity.value|default:'' }}">
          {% if form.seat_capacity.errors %}
            <div class="invalid-feedback">
              <i class="fas fa-exclamation-circle me-1"></i> {{ form.seat_capacity.errors.0 }}
            </div>
          {% endif %}
          <small class="form-text text-muted">
            <i class="fas fa-lightbulb me-1"></i> Enter the maximum number of passengers
          </small>
        </div>
      </div>
    </div>

    <!-- Registration Information -->
    <div class="section-box">
      <h2 class="section-title">
        <i class="fas fa-file-alt me-2"></i> Registration Information
      </h2>

      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="{{ form.cr_number.id_for_label }}" class="form-label required">
            <i class="fas fa-file-certificate me-1"></i> CR Number
          </label>
          <input type="text" 
                 name="{{ form.cr_number.name }}"
                 id="{{ form.cr_number.id_for_label }}"
                 class="form-control {% if form.cr_number.errors %}is-invalid{% endif %}"
                 placeholder="e.g. 123456789012"
                 value="{{ form.cr_number.value|default:'' }}"
                 required>
          {% if form.cr_number.errors %}
            <div class="invalid-feedback">
              <i class="fas fa-exclamation-circle me-1"></i> {{ form.cr_number.errors.0 }}
            </div>
          {% else %}
            <div class="invalid-feedback">
              <i class="fas fa-exclamation-circle me-1"></i> Please provide a valid CR number.
            </div>
          {% endif %}
          <small class="form-text text-muted">
            <i class="fas fa-lightbulb me-1"></i> Enter the Certificate of Registration number
          </small>
        </div>
        
        <div class="form-group col-md-6">
          <label for="{{ form.or_number.id_for_label }}" class="form-label required">
            <i class="fas fa-receipt me-1"></i> OR Number
          </label>
          <input type="text" 
                 name="{{ form.or_number.name }}"
                 id="{{ form.or_number.id_for_label }}"
                 class="form-control {% if form.or_number.errors %}is-invalid{% endif %}"
                 placeholder="e.g. 123456789012"
                 value="{{ form.or_number.value|default:'' }}"
                 required>
          {% if form.or_number.errors %}
            <div class="invalid-feedback">
              <i class="fas fa-exclamation-circle me-1"></i> {{ form.or_number.errors.0 }}
            </div>
          {% else %}
            <div class="invalid-feedback">
              <i class="fas fa-exclamation-circle me-1"></i> Please provide a valid OR number.
            </div>
          {% endif %}
          <small class="form-text text-muted">
            <i class="fas fa-lightbulb me-1"></i> Enter the Official Receipt number
          </small>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="{{ form.vin_number.id_for_label }}" class="form-label required">
            <i class="fas fa-barcode me-1"></i> VIN Number
          </label>
          <input type="text" 
                 name="{{ form.vin_number.name }}"
                 id="{{ form.vin_number.id_for_label }}"
                 class="form-control {% if form.vin_number.errors %}is-invalid{% endif %}"
                 placeholder="e.g. JT2BF22K1W0123456"
                 value="{{ form.vin_number.value|default:'' }}"
                 required>
          {% if form.vin_number.errors %}
            <div class="invalid-feedback">
              <i class="fas fa-exclamation-circle me-1"></i> {{ form.vin_number.errors.0 }}
            </div>
          {% else %}
            <div class="invalid-feedback">
              <i class="fas fa-exclamation-circle me-1"></i> Please provide a valid 17-character VIN number.
            </div>
          {% endif %}
          <small class="form-text text-muted">
            <i class="fas fa-lightbulb me-1"></i> Enter the 17-character Vehicle Identification Number
          </small>
        </div>
        
        <div class="form-group col-md-6">
          <label for="{{ form.year_model.id_for_label }}" class="form-label required">
            <i class="fas fa-calendar-alt me-1"></i> Year Model
          </label>
          {{ form.year_model }}
          {% if form.year_model.errors %}
            <div class="invalid-feedback">
              <i class="fas fa-exclamation-circle me-1"></i> {{ form.year_model.errors.0 }}
            </div>
          {% else %}
            <div class="invalid-feedback">
              <i class="fas fa-exclamation-circle me-1"></i> Please select the vehicle's year model.
            </div>
          {% endif %}
          <small class="form-text text-muted">
            <i class="fas fa-lightbulb me-1"></i> Select the vehicle's manufacturing year
          </small>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="{{ form.registration_number.id_for_label }}" class="form-label required">
            <i class="fas fa-hashtag me-1"></i> Registration Number
          </label>
          <input type="text" 
                 name="{{ form.registration_number.name }}"
                 id="{{ form.registration_number.id_for_label }}"
                 class="form-control {% if form.registration_number.errors %}is-invalid{% endif %}"
                 placeholder="e.g. NX123456"
                 value="{{ form.registration_number.value|default:'' }}"
                 required>
          {% if form.registration_number.errors %}
            <div class="invalid-feedback">
              <i class="fas fa-exclamation-circle me-1"></i> {{ form.registration_number.errors.0 }}
            </div>
          {% else %}
            <div class="invalid-feedback">
              <i class="fas fa-exclamation-circle me-1"></i> Please provide a valid registration number.
            </div>
          {% endif %}
          <small class="form-text text-muted">
            <i class="fas fa-lightbulb me-1"></i> Enter the vehicle's registration number
          </small>
        </div>
        
        <div class="form-group col-md-6">
          <div class="date-wrapper">
            <label for="{{ form.registration_expiry.id_for_label }}" class="form-label required">
              <i class="fas fa-calendar-times me-1"></i> Registration Expiry
            </label>
            <input type="text" 
                   name="{{ form.registration_expiry.name }}"
                   id="{{ form.registration_expiry.id_for_label }}"
                   class="form-control {% if form.registration_expiry.errors %}is-invalid{% endif %}"
                   placeholder="YYYY-MM-DD"
                   value="{{ form.registration_expiry.value|default:'' }}"
                   autocomplete="off"
                   required>
            {% if form.registration_expiry.errors %}
              <div class="invalid-feedback">
                <i class="fas fa-exclamation-circle me-1"></i> {{ form.registration_expiry.errors.0 }}
              </div>
            {% else %}
              <div class="invalid-feedback">
                <i class="fas fa-exclamation-circle me-1"></i> Please select the registration expiry date.
              </div>
            {% endif %}
            <div id="calendar_regexpiry" class="custom-calendar"></div>
            <small class="form-text text-muted">
              <i class="fas fa-calendar-check me-1"></i> Click to select the registration expiry date
            </small>
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="{{ form.license_plate.id_for_label }}" class="form-label required">
            <i class="fas fa-rectangle-list me-1"></i> License Plate
          </label>
          <input type="text" 
                 name="{{ form.license_plate.name }}"
                 id="{{ form.license_plate.id_for_label }}"
                 class="form-control {% if form.license_plate.errors %}is-invalid{% endif %}"
                 placeholder="e.g. ABC123"
                 value="{{ form.license_plate.value|default:'' }}"
                 required>
          {% if form.license_plate.errors %}
            <div class="invalid-feedback">
              <i class="fas fa-exclamation-circle me-1"></i> {{ form.license_plate.errors.0 }}
            </div>
          {% else %}
            <div class="invalid-feedback">
              <i class="fas fa-exclamation-circle me-1"></i> Please provide a valid license plate number.
            </div>
          {% endif %}
          <small class="form-text text-muted">
            <i class="fas fa-lightbulb me-1"></i> Enter the vehicle's license plate number
          </small>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-end mt-4">
      <button type="submit" class="btn-submit">
        <i class="fas fa-check-circle me-2"></i> Register Vehicle
      </button>
    </div>
  </form>
</div>

<!-- Select2 -->
<link href="{% static 'css/select2.min.css' %}" rel="stylesheet">
<script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
<script src="{% static 'js/select2.min.js' %}"></script>

<style>
/* Custom CSS for driver dropdown with profile pictures */
.driver-option {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 5px;
}

.driver-pfp-small {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #e2e8f0;
  background: #f8fafc;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.driver-pfp-small i {
  font-size: 16px;
  color: #64748b;
}

.driver-info-small {
  flex: 1;
  min-width: 0;
}

.driver-name-small {
  font-weight: 600;
  font-size: 14px;
  color: #0f172a;
  margin-bottom: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.driver-id-small {
  font-size: 12px;
  color: #64748b;
  font-weight: 500;
}

/* Select2 custom styling */
.select2-results__option .driver-option {
  border-bottom: 1px solid #f1f5f9;
}

.select2-results__option:last-child .driver-option {
  border-bottom: none;
}

.select2-container--default .select2-results__option--highlighted .driver-option {
  background-color: #e8f4fd;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
  display: flex;
  align-items: center;
}

/* For selected item in dropdown */
.select2-selection__rendered .driver-option {
  padding: 2px 0;
}
</style>

<script>
$(document).ready(function() {
  // Initialize Select2 for route
  $('#id_route').select2({ width: '100%' });
  
  // Initialize Select2 for assigned driver with custom template
  $('#id_assigned_driver').select2({
    width: '100%',
    templateResult: formatDriverOption,
    templateSelection: formatDriverSelection,
    escapeMarkup: function(m) { return m; }
  });
  
  // Function to format driver option in dropdown
  function formatDriverOption(driver) {
    if (!driver.id) {
      return driver.text;
    }
    
    // Get driver data from element
    var $driver = $(driver.element);
    var driverId = $driver.data('driver-id');
    var photoUrl = $driver.data('photo-url');
    var driverName = driver.text;
    
    if (!driverName) {
      return driver.text;
    }
    
    var photoHtml = '';
    if (photoUrl) {
      photoHtml = `<img src="${photoUrl}" alt="${driverName}" class="driver-pfp-small">`;
    } else {
      photoHtml = `<div class="driver-pfp-small"><i class="fas fa-user"></i></div>`;
    }
    
    return $(`
      <div class="driver-option">
        ${photoHtml}
        <div class="driver-info-small">
          <div class="driver-name-small">${driverName}</div>
          <div class="driver-id-small">ID: ${driverId || 'N/A'}</div>
        </div>
      </div>
    `);
  }
  
  // Function to format selected driver
  function formatDriverSelection(driver) {
    if (!driver.id) {
      return driver.text;
    }
    
    var $driver = $(driver.element);
    var driverName = driver.text;
    
    if (!driverName) {
      return driver.text;
    }
    
    return $(`
      <div class="driver-option" style="padding: 0;">
        <div class="driver-info-small">
          <div class="driver-name-small">${driverName}</div>
        </div>
      </div>
    `);
  }
  
  // Add data attributes to driver options
  $('#id_assigned_driver option').each(function() {
    var $option = $(this);
    var driverId = $option.val();
    if (driverId) {
      // You need to fetch driver data - this should be done in your view
      // For now, we'll add placeholder data
      $option.data('driver-id', driverId);
      // You would need to add the photo URL as a data attribute from your view
      // Example: data-photo-url="{{ driver.driver_photo.url }}"
    }
  });
});

</script>


<!-- YEAR MODEL DROPDOWN -->
<script>
const yearSelect = document.getElementById("id_year_model");
const currentYear = new Date().getFullYear();

for (let y = 2000; y <= currentYear; y++) {
  let opt = document.createElement("option");
  opt.value = y;
  opt.textContent = y;
  yearSelect.appendChild(opt);
}

// Make dropdown height short
yearSelect.style.maxHeight = "38px";
yearSelect.style.padding = "6px 10px";
</script>


<!-- CUSTOM CALENDAR -->
<script>
function createCalendar(inputId, calendarId, minYear, maxYear) {

  const input = document.getElementById(inputId);
  const wrapper = document.getElementById(inputId).parentElement;
  const box = wrapper.querySelector(".custom-calendar");


  input.type = "text"; // force text for styling

  let today = new Date();
  let month = today.getMonth();
  let year = today.getFullYear();

  function render() {
    box.innerHTML = "";

    // HEADER
    let header = document.createElement("div");
    header.className = "cal-header";

    // MONTH SELECT
    let monthSel = document.createElement("select");
    const monthNames = [
      "January","February","March","April","May","June",
      "July","August","September","October","November","December"
    ];

    monthNames.forEach((m, i) => {
      let opt = document.createElement("option");
      opt.value = i;
      opt.textContent = m;
      if (i === month) opt.selected = true;
      monthSel.appendChild(opt);
    });

    // YEAR SELECT
    let yearSel = document.createElement("select");
    yearSel.className = "year-select";

    for (let y = minYear; y <= maxYear; y++) {
      let opt = document.createElement("option");
      opt.value = y;
      opt.textContent = y;
      if (y === year) opt.selected = true;
      yearSel.appendChild(opt);
    }

    monthSel.onchange = () => { month = parseInt(monthSel.value); render(); };
    yearSel.onchange = () => { year = parseInt(yearSel.value); render(); };

    header.appendChild(monthSel);
    header.appendChild(yearSel);
    box.appendChild(header);

    // WEEKDAYS
    let daysRow = document.createElement("div");
    daysRow.className = "cal-days";
    ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"].forEach(d => {
      let el = document.createElement("div");
      el.textContent = d;
      daysRow.appendChild(el);
    });
    box.appendChild(daysRow);

    // DAYS GRID
    let grid = document.createElement("div");
    grid.className = "cal-grid";
    box.appendChild(grid);

    const firstDay = new Date(year, month, 1).getDay();
    const totalDays = new Date(year, month + 1, 0).getDate();

    for (let i = 0; i < firstDay; i++) {
      grid.appendChild(document.createElement("div"));
    }

    for (let d = 1; d <= totalDays; d++) {
      let day = document.createElement("div");
      day.className = "cal-day";
      day.textContent = d;

      let today = new Date();
      if (year === today.getFullYear() &&
          month === today.getMonth() &&
          d === today.getDate()) {
        day.classList.add("today");
      }

      day.onclick = () => {
        input.value = `${year}-${String(month + 1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        box.style.display = "none";
      };

      grid.appendChild(day);
    }
  }

  // OPEN CALENDAR BELOW INPUT
  input.addEventListener("click", () => {
    box.style.display = "block";
    render();
  });

  // CLOSE CALENDAR WHEN CLICKING OUTSIDE
  document.addEventListener("click", (e) => {
    if (!wrapper.contains(e.target)) {
      box.style.display = "none";
    }
  });
}

createCalendar("id_registration_expiry", "calendar_regexpiry", 2000, 2045);
</script>

{% endblock %}