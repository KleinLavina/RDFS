{% extends 'base.html' %}
{% load static %}
{% block title %}Deposit Management | RDFS{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'styles/terminal/deposits.css' %}?v=2">

<div class="deposits-page">

  <!-- PAGE HEADER -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="fas fa-wallet me-2"></i>
        Deposit Management
      </h1>
      <p class="page-subtitle">
        <i class="fas fa-info-circle me-1"></i>
        Manage driver wallet deposits and view transaction history
      </p>
    </div>

    {% if user.role == 'admin' %}
      <a href="{% url 'accounts:admin_dashboard' %}" class="btn-back">
        <i class="fas fa-arrow-left me-2"></i>
        Back to Dashboard
      </a>
    {% else %}
      <a href="{% url 'accounts:staff_dashboard' %}" class="btn-back">
        <i class="fas fa-arrow-left me-2"></i>
        Back to Dashboard
      </a>
    {% endif %}
  </div>

  <!-- FLASH MESSAGES -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- TABS NAVIGATION -->
  <div class="tabs-container">
    <button class="tab-btn active" data-tab="wallets">
      <i class="fas fa-wallet me-2"></i>
      Driver Wallets
    </button>
    <button class="tab-btn" data-tab="history">
      <i class="fas fa-check-circle me-2"></i>
      Approved Deposits
    </button>
    <button class="tab-btn" data-tab="pending">
      <i class="fas fa-clock me-2"></i>
      Pending Approvals
      {% if pending_count > 0 %}
        <span class="badge-count">{{ pending_count }}</span>
      {% endif %}
    </button>
  </div>

  <!-- TAB CONTENT: WALLETS -->
  <div class="tab-content active" id="wallets-tab">
    
    <!-- INFO BANNER (READ-ONLY) -->
    <div class="info-banner">
      <div class="banner-content">
        <i class="fas fa-info-circle me-2"></i>
        <strong>Read-Only View:</strong>
        <span>Showing approved deposits only. Minimum Balance: ₱{{ min_deposit }}</span>
      </div>
    </div>

    <!-- STATS GRID -->
    <div class="stats-grid">
      {% if user.role == 'admin' %}
      <div class="stat-card">
        <div class="stat-icon wallets-icon">
          <i class="fas fa-wallet"></i>
        </div>
        <div class="stat-info">
          <div class="stat-value">{{ wallets_total }}</div>
          <div class="stat-label">Total Wallets</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon balance-icon">
          <i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="stat-info">
          <div class="stat-value">₱{{ total_balance|floatformat:2 }}</div>
          <div class="stat-label">Total Balance</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon deposits-icon">
          <i class="fas fa-receipt"></i>
        </div>
        <div class="stat-info">
          <div class="stat-value">{{ total_deposits }}</div>
          <div class="stat-label">Total Deposits Made</div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- SEARCH & FILTER -->
    <div class="content-card">
      <h2 class="section-title">
        <i class="fas fa-search me-2"></i>
        Search & Filter
      </h2>

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-magnifying-glass me-1"></i>
            Live Search
          </label>
          <input type="text"
                 id="liveSearchInput"
                 class="form-control"
                 placeholder="Driver name, license, or plate..."
                 value="{{ wallet_search }}">
          <small class="form-hint">Search updates automatically as you type</small>
        </div>

        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-sort me-1"></i>
            Sort By
          </label>
          <select id="liveSortSelect" class="form-select">
            <option value="newest" {% if wallet_sort == 'newest' %}selected{% endif %}>Newest Deposits</option>
            <option value="largest" {% if wallet_sort == 'largest' %}selected{% endif %}>Largest Balance</option>
            <option value="smallest" {% if wallet_sort == 'smallest' %}selected{% endif %}>Smallest Balance</option>
            <option value="driver_asc" {% if wallet_sort == 'driver_asc' %}selected{% endif %}>Driver A → Z</option>
            <option value="driver_desc" {% if wallet_sort == 'driver_desc' %}selected{% endif %}>Driver Z → A</option>
          </select>
          <small class="form-hint" style="visibility: hidden;">&nbsp;</small>
        </div>
      </div>

      <div class="search-status">
        <span id="visibleCount">{{ wallets|length }}</span> of <span id="totalCount">{{ wallets_total }}</span> wallets
        <div class="loading-indicator" id="loadingIndicator">
          <i class="fas fa-spinner fa-spin"></i>
          <span>Searching...</span>
        </div>
      </div>
    </div>

    <!-- WALLETS TABLE -->
    <div class="content-card">
      <h2 class="section-title">
        <i class="fas fa-list me-2"></i>
        Driver Wallets
      </h2>

      <div class="table-container">
        <table class="wallets-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Driver</th>
              <th>License Plate</th>
              <th>Current Balance</th>
              <th>Last Approved Deposit</th>
              <th>Last Deposit Date</th>
              <th>Total Approved</th>
            </tr>
          </thead>
          <tbody id="walletsTableBody">
            {% if wallets %}
              {% for wallet in wallets %}
                <tr data-driver="{{ wallet.vehicle.assigned_driver.first_name|lower }} {{ wallet.vehicle.assigned_driver.last_name|lower }}"
                    data-plate="{{ wallet.vehicle.license_plate|lower }}"
                    data-license="{{ wallet.vehicle.assigned_driver.license_number|lower|default:'' }}"
                    data-balance="{{ wallet.balance }}"
                    data-date="{{ wallet.last_deposit_at|date:'Y-m-d H:i:s'|default:'0000-00-00' }}">
                  <td class="row-number">{{ forloop.counter }}</td>
                  <td class="fw-semibold">
                    {{ wallet.vehicle.assigned_driver.first_name }} {{ wallet.vehicle.assigned_driver.last_name }}
                  </td>
                  <td>
                    <span class="plate-badge">{{ wallet.vehicle.license_plate }}</span>
                  </td>
                  <td>
                    {% if wallet.balance >= 500 %}
                      <span class="balance-badge high">₱{{ wallet.balance|floatformat:2 }}</span>
                    {% elif wallet.balance >= 200 %}
                      <span class="balance-badge medium">₱{{ wallet.balance|floatformat:2 }}</span>
                    {% elif wallet.balance >= min_deposit %}
                      <span class="balance-badge low">₱{{ wallet.balance|floatformat:2 }}</span>
                    {% else %}
                      <span class="balance-badge critical">₱{{ wallet.balance|floatformat:2 }}</span>
                    {% endif %}
                  </td>
                  <td>₱{{ wallet.last_deposit_amount|default:"0.00"|floatformat:2 }}</td>
                  <td>
                    {% if wallet.last_deposit_at %}
                      {{ wallet.last_deposit_at|date:"M d, Y h:i A" }}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="count-badge">{{ wallet.deposit_count }}</span>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr id="emptyRow">
                <td colspan="7" class="text-center text-muted py-4">
                  <i class="fas fa-inbox fs-1 d-block mb-2 opacity-50"></i>
                  No wallets found
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TAB CONTENT: APPROVED DEPOSITS -->
  <div class="tab-content" id="history-tab">
    
    <!-- HISTORY STATS -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon history-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-info">
          <div class="stat-value">{{ history_count }}</div>
          <div class="stat-label">Approved Deposits ({{ selected_month_name }})</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon amount-icon">
          <i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="stat-info">
          <div class="stat-value">₱{{ history_total|floatformat:2 }}</div>
          <div class="stat-label">Total Approved Amount ({{ selected_month_name }})</div>
        </div>
      </div>
    </div>

    <!-- MONTH NAVIGATION -->
    <div class="content-card">
      <h2 class="section-title">
        <i class="fas fa-calendar me-2"></i>
        Month Selection
      </h2>
      
      <div class="month-navigation">
        <a href="?tab=history&month={{ prev_month }}" 
           class="btn-month-nav {% if not has_prev_month %}disabled{% endif %}"
           {% if not has_prev_month %}aria-disabled="true"{% endif %}>
          <i class="fas fa-chevron-left"></i> Previous Month
        </a>
        
        <div class="current-month">
          <i class="fas fa-calendar-day me-2"></i>
          <strong>{{ selected_month_name }}</strong>
        </div>
        
        <a href="?tab=history&month={{ next_month }}" 
           class="btn-month-nav {% if not has_next_month %}disabled{% endif %}"
           {% if not has_next_month %}aria-disabled="true"{% endif %}>
          Next Month <i class="fas fa-chevron-right"></i>
        </a>
      </div>
      
      <div class="month-selector-export-row">
        <div class="month-selector-inline">
          <label for="monthSelect" class="form-label">
            <i class="fas fa-calendar-alt me-1"></i>
            Jump to Month:
          </label>
          <select id="monthSelect" class="form-select" onchange="window.location.href='?tab=history&month=' + this.value">
            {% for month_data in available_months %}
              <option value="{{ month_data.month|date:'Y-m' }}" 
                      {% if month_data.month|date:'Y-m' == selected_month %}selected{% endif %}>
                {{ month_data.month|date:"F Y" }}
              </option>
            {% endfor %}
          </select>
        </div>
        
        <a href="?tab=history&month={{ selected_month }}&export=csv" class="btn-export">
          <i class="fas fa-file-csv me-2"></i>
          Export {{ selected_month_name }} to CSV
        </a>
      </div>
    </div>

    <!-- HISTORY TABLE -->
    <div class="content-card">
      <h2 class="section-title">
        <i class="fas fa-check-double me-2"></i>
        Approved Deposit Records
      </h2>

      <div class="table-container">
        <table class="history-table">
          <thead>
            <tr>
              <th>#</th>
              <th>OR Code</th>
              <th>Driver</th>
              <th>Vehicle</th>
              <th>Amount</th>
              <th>Approved By</th>
              <th>Date & Time</th>
              <th class="text-center">View</th>
            </tr>
          </thead>
          <tbody id="historyTableBody">
            {% if history_deposits %}
              {% for deposit in history_deposits %}
                <tr data-driver="{{ deposit.wallet.vehicle.assigned_driver.first_name|lower }} {{ deposit.wallet.vehicle.assigned_driver.last_name|lower }}"
                    data-plate="{{ deposit.wallet.vehicle.license_plate|lower }}"
                    data-license="{{ deposit.wallet.vehicle.assigned_driver.license_number|lower|default:'' }}"
                    data-amount="{{ deposit.amount }}"
                    data-date="{{ deposit.created_at|date:'Y-m-d H:i:s' }}">
                  <td class="history-row-number">{{ forloop.counter }}</td>
                  <td>
                    <span class="or-code-highlight" style="background: #fff3cd; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 700; color: #856404;">
                      {{ deposit.or_code|default:"—" }}
                    </span>
                  </td>
                  <td class="fw-semibold">
                    {{ deposit.wallet.vehicle.assigned_driver.first_name }}
                    {{ deposit.wallet.vehicle.assigned_driver.last_name }}
                  </td>
                  <td>
                    <span class="plate-badge">{{ deposit.wallet.vehicle.license_plate }}</span>
                  </td>
                  <td>
                    <span class="amount-badge">₱{{ deposit.amount|floatformat:2 }}</span>
                  </td>
                  <td>
                    {% if deposit.approved_by %}
                      {{ deposit.approved_by.get_full_name }}
                    {% else %}
                      <span class="text-muted">System</span>
                    {% endif %}
                  </td>
                  <td>{{ deposit.created_at|date:"M d, Y h:i A" }}</td>
                  <td class="text-center">
                    <a href="{% url 'terminal:treasurer_deposit_details' deposit.id %}" 
                       class="btn-action btn-view-details" 
                       title="View Details">
                      <i class="fas fa-eye"></i>
                    </a>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr id="historyEmptyRow">
                <td colspan="8" class="text-center text-muted py-4">
                  <i class="fas fa-inbox fs-1 d-block mb-2 opacity-50"></i>
                  No approved deposits found for this month
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TAB CONTENT: PENDING APPROVALS -->
  <div class="tab-content" id="pending-tab">
    
    <div class="alert alert-info" style="background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; padding: 1rem 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
      <i class="fas fa-info-circle"></i>
      <strong>Important:</strong> Verify the printed OR proof before approving. Check that OR Code, Amount, and Driver match the physical receipt.
    </div>

    <div class="content-card">
      <h2 class="section-title">
        <i class="fas fa-clock me-2"></i>
        Pending Deposit Approvals
      </h2>
      
      {% if pending_deposits %}
      <div class="table-container">
        <table class="history-table">
          <thead>
            <tr>
              <th>OR Number</th>
              <th>Driver Name</th>
              <th>Plate Number</th>
              <th>Deposit Amount</th>
              <th>Date Created</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for deposit in pending_deposits %}
            <tr>
              <td>
                <span class="or-code-highlight" style="background: #fff3cd; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 700; color: #856404;">
                  {{ deposit.or_code }}
                </span>
              </td>
              <td>
                <strong>{{ deposit.wallet.vehicle.assigned_driver.first_name }} {{ deposit.wallet.vehicle.assigned_driver.last_name }}</strong>
              </td>
              <td>
                <span class="plate-badge">{{ deposit.wallet.vehicle.license_plate }}</span>
              </td>
              <td>
                <span class="amount-badge">₱{{ deposit.amount|floatformat:2 }}</span>
              </td>
              <td>{{ deposit.created_at|date:"M d, Y g:i A" }}</td>
              <td>
                <div class="action-buttons-icon" style="display: flex; gap: 0.5rem; justify-content: center; align-items: center; flex-wrap: nowrap;">
                  <a href="{% url 'terminal:treasurer_deposit_details' deposit.id %}" 
                     class="btn-action-icon btn-view-icon" 
                     title="View Details"
                     style="display: inline-flex; align-items: center; justify-content: center; width: 36px; height: 36px; background: #e3f2fd; color: #1976d2; border-radius: 6px; text-decoration: none; transition: all 0.2s ease;">
                    <i class="fas fa-eye"></i>
                  </a>
                  <button type="button"
                          class="btn-action-icon btn-approve-icon" 
                          title="Approve"
                          onclick="showApproveModal('{{ deposit.id }}', '{{ deposit.or_code }}', '{{ deposit.amount|floatformat:2 }}', '{{ deposit.wallet.vehicle.assigned_driver.first_name }} {{ deposit.wallet.vehicle.assigned_driver.last_name }}')"
                          style="display: inline-flex; align-items: center; justify-content: center; width: 36px; height: 36px; background: #d4edda; color: #28a745; border-radius: 6px; border: none; cursor: pointer; transition: all 0.2s ease;">
                    <i class="fas fa-check"></i>
                  </button>
                  <button type="button"
                          class="btn-action-icon btn-reject-icon" 
                          title="Reject"
                          onclick="showRejectModal('{{ deposit.id }}', '{{ deposit.or_code }}', '{{ deposit.amount|floatformat:2 }}', '{{ deposit.wallet.vehicle.assigned_driver.first_name }} {{ deposit.wallet.vehicle.assigned_driver.last_name }}')"
                          style="display: inline-flex; align-items: center; justify-content: center; width: 36px; height: 36px; background: #f8d7da; color: #dc3545; border-radius: 6px; border: none; cursor: pointer; transition: all 0.2s ease;">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="no-data">
        <i class="fas fa-check-circle fs-1 d-block mb-2 opacity-50"></i>
        <p>No pending deposit requests at this time.</p>
      </div>
      {% endif %}
    </div>
  </div>

</div>

<!-- Approve Confirmation Modal -->
<div class="modal fade" id="approveModal" tabindex="-1" aria-labelledby="approveModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="approveModalLabel">
          <i class="fas fa-check-circle me-2"></i>
          Approve Deposit
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-success mb-3">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Confirmation Required</strong>
        </div>
        <p class="mb-3">Are you sure you want to approve this deposit?</p>
        <div class="deposit-details p-3 bg-light rounded">
          <div class="row mb-2">
            <div class="col-5 fw-bold">OR Code:</div>
            <div class="col-7" id="approveORCode"></div>
          </div>
          <div class="row mb-2">
            <div class="col-5 fw-bold">Driver:</div>
            <div class="col-7" id="approveDriver"></div>
          </div>
          <div class="row">
            <div class="col-5 fw-bold">Amount:</div>
            <div class="col-7 text-success fw-bold" id="approveAmount"></div>
          </div>
        </div>
        <p class="mt-3 mb-0 text-muted small">
          <i class="fas fa-exclamation-triangle me-1"></i>
          The wallet will be credited with this amount.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>
          Cancel
        </button>
        <form method="POST" id="approveForm" style="display: inline; margin: 0;">
          {% csrf_token %}
          <input type="hidden" name="deposit_id" id="approveDepositId">
          <input type="hidden" name="action" value="approve">
          <button type="submit" class="btn btn-success">
            <i class="fas fa-check me-1"></i>
            Approve Deposit
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Reject Confirmation Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="rejectModalLabel">
          <i class="fas fa-times-circle me-2"></i>
          Reject Deposit
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger mb-3">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Warning: This action cannot be undone</strong>
        </div>
        <p class="mb-3">Are you sure you want to reject this deposit?</p>
        <div class="deposit-details p-3 bg-light rounded">
          <div class="row mb-2">
            <div class="col-5 fw-bold">OR Code:</div>
            <div class="col-7" id="rejectORCode"></div>
          </div>
          <div class="row mb-2">
            <div class="col-5 fw-bold">Driver:</div>
            <div class="col-7" id="rejectDriver"></div>
          </div>
          <div class="row">
            <div class="col-5 fw-bold">Amount:</div>
            <div class="col-7 text-danger fw-bold" id="rejectAmount"></div>
          </div>
        </div>
        <p class="mt-3 mb-0 text-muted small">
          <i class="fas fa-info-circle me-1"></i>
          No wallet update will occur.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-arrow-left me-1"></i>
          Cancel
        </button>
        <form method="POST" id="rejectForm" style="display: inline; margin: 0;">
          {% csrf_token %}
          <input type="hidden" name="deposit_id" id="rejectDepositId">
          <input type="hidden" name="action" value="reject">
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-times me-1"></i>
            Reject Deposit
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- SCRIPTS -->
<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
<script>
// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const tabName = this.dataset.tab;
    
    // Update URL without reload
    const url = new URL(window.location);
    url.searchParams.set('tab', tabName);
    window.history.pushState({}, '', url);
    
    // Update active states
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    this.classList.add('active');
    document.getElementById(tabName + '-tab').classList.add('active');
  });
});

// Modal functions for approve/reject
function showApproveModal(depositId, orCode, amount, driverName) {
  document.getElementById('approveDepositId').value = depositId;
  document.getElementById('approveORCode').textContent = orCode;
  document.getElementById('approveDriver').textContent = driverName;
  document.getElementById('approveAmount').textContent = '₱' + amount;
  
  const modal = new bootstrap.Modal(document.getElementById('approveModal'));
  modal.show();
}

function showRejectModal(depositId, orCode, amount, driverName) {
  document.getElementById('rejectDepositId').value = depositId;
  document.getElementById('rejectORCode').textContent = orCode;
  document.getElementById('rejectDriver').textContent = driverName;
  document.getElementById('rejectAmount').textContent = '₱' + amount;
  
  const modal = new bootstrap.Modal(document.getElementById('rejectModal'));
  modal.show();
}

// Set active tab from URL on load
const urlParams = new URLSearchParams(window.location.search);
const activeTab = urlParams.get('tab') || 'wallets';
if (activeTab !== 'wallets') {
  document.querySelector(`[data-tab="${activeTab}"]`)?.click();
}
</script>

{% endblock %}
